<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ウェディングパーティー  🏇サンレンタン🏇｜馬券投票ページ</title>
  <style>
    :root {
      /* 明るいトーン */
      --bg:#f7fbff; --card:#ffffff; --ink:#0f172a; --muted:#64748b; --line:#e2e8f0; --acc:#16a34a; --acc-ink:#062b12; --soft:#f1f5f9; --focus:#60a5fa; --race:#0ea5e9;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic UI","Meiryo",sans-serif}
    .wrap{max-width:980px;margin:0 auto;padding:24px}
    h1{margin:0 0 10px;font-size:24px}
    .lead{color:var(--muted);margin:0 0 12px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px}
    .row{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:780px){.row{grid-template-columns:1fr 1fr}}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,select{width:100%;background:#fff;color:var(--ink);border:1px solid var(--line);border-radius:10px;padding:10px}
    input:focus,select:focus{outline:3px solid color-mix(in oklab, var(--focus) 35%, transparent); border-color:var(--focus)}
    .btn{background:var(--acc);color:var(--acc-ink);border:none;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer}
    .btn.secondary{background:#e6f7ec;color:#064e3b;border:1px solid #b7ebc6}
    .btn.ghost{background:#ffffff; border:1px solid var(--line); color:#0f172a}
    .tips{font-size:12px;color:var(--muted)}
    canvas{max-width:100%;height:auto;border-radius:12px;border:1px solid var(--line);background:#fff}
  </style>
  <!-- 任意：プリロード（同一オリジンの固定ベース画像） -->
  <link rel="preload" as="image" href="img/test.png">
</head>
<body>
  <div class="wrap">
    <h1>ウェディングパーティー  🏇サンレンタン🏇｜馬券投票ページ</h1>
    <p class="lead">第1問 新郎の好きな女性芸能人は？</p>

    <div class="card" style="margin-top:8px">
      <form id="quizForm" onsubmit="return false;" class="row">
        <div>
          <label>ニックネーム</label>
          <input id="nickname" placeholder="例: はらそ" />
        </div>
        <div>
          <label>1位 予想</label>
          <select id="pick1" required>
            <option value="">選択してください</option>
            <option>1 有村架純</option><option>2 多部未華子</option><option>3 あの</option><option>4 幾田りら</option><option>5 ヒコロヒー</option><option>6 ラランドサーヤ</option><option>7 だれか</option>
          </select>
        </div>
        <div>
          <label>2位 予想</label>
          <select id="pick2" required>
            <option value="">選択してください</option>
            <option>1 有村架純</option><option>2 多部未華子</option><option>3 あの</option><option>4 幾田りら</option><option>5 ヒコロヒー</option><option>6 ラランドサーヤ</option><option>7 だれか</option>
          </select>
        </div>
        <div>
          <label>3位 予想</label>
          <select id="pick3">
            <option value="">選択してください</option>
            <option>1 有村架純</option><option>2 多部未華子</option><option>3 あの</option><option>4 幾田りら</option><option>5 ヒコロヒー</option><option>6 ラランドサーヤ</option><option>7 だれか</option>
          </select>
        </div>
        <div style="grid-column:1/-1; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <button class="btn" id="submitBtn">馬券発行</button>
          <a id="downloadLink" class="btn secondary" download>画像保存</a>
          <button id="copyBtn" type="button" class="btn ghost">画像をコピー</button>
          <span id="status" class="tips"></span>
        </div>
      </form>
      <p class="tips" style="margin-top:8px">※ ベース画像は <code>img/test.png</code> を利用します。<br>GitHub Pages（Project Pages）の場合、<code>index.html</code> と同階層に <code>img/</code> フォルダを置いてください。</p>
    </div>

    <div class="card" style="margin-top:12px">
      <h3 style="margin:0 0 8px">プレビュー</h3>
      <canvas id="ticket" width="850" height="530" aria-label="馬券風プレビュー"></canvas>
    </div>
  </div>

<script>
  const $ = (s)=>document.querySelector(s);
  const canvas = $('#ticket');
  const ctx = canvas.getContext('2d');

  // 固定ベース画像の設定
  const BASE_IMAGE_URL = 'img/test.png'; // リポジトリ内の相対パス
  const BASE_FIT = 'cover';              // 'cover' or 'contain'

  // 明るいパレット
  const theme = { bg:'#f7fbff', panel:'#ffffff', ink:'#0f172a', sub:'#475569', accent:'#16a34a', line:'#e2e8f0', subtle:'#f1f5f9', race:'#0ea5e9' };

  const pad = (n)=> String(n).padStart(2,'0');
  const formatTs = (d)=> `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  const trunc=(s,n)=>!s? s : (s.length>n? s.slice(0,n-1)+'…':s);

  let baseImg = null; // キャッシュ

  function loadImage(url){
    return new Promise((resolve,reject)=>{
      const img = new Image();
      // 同一オリジン想定（GitHub Pages/Netlifyなど）。CORS不要。
      img.onload = ()=> resolve(img);
      img.onerror = (e)=> reject(e);
      img.src = url + (url.includes('?')?'&':'?') + 't=' + Date.now(); // キャッシュバイパス
    });
  }

  function drawFittedImage(img, fit){
    const W = canvas.width, H = canvas.height;
    const ir = img.width / img.height; const cr = W / H;
    let dw, dh, dx, dy;
    if(fit==='contain'){
      const ratio = cr > ir ? H / img.height : W / img.width;
      dw = Math.round(img.width * ratio); dh = Math.round(img.height * ratio);
      dx = Math.round((W - dw) / 2); dy = Math.round((H - dh) / 2);
    }else{ // cover
      const ratio = cr > ir ? W / img.width : H / img.height;
      dw = Math.round(img.width * ratio); dh = Math.round(img.height * ratio);
      dx = Math.round((W - dw) / 2); dy = Math.round((H - dh) / 2);
    }
    ctx.drawImage(img, dx, dy, dw, dh);
  }

  function lightBand(x,y,w,h){
    const g = ctx.createLinearGradient(x,y,x+w,y);
    g.addColorStop(0,'#e0f2fe'); g.addColorStop(0.55,'#bae6fd'); g.addColorStop(1,'#bbf7d0');
    ctx.fillStyle=g; ctx.fillRect(x,y,w,h);
  }

  function roundRect(x,y,w,h,r,fill=true){
    ctx.beginPath();
    ctx.moveTo(x+r,y);
    ctx.arcTo(x+w,y,x+w,y+h,r);
    ctx.arcTo(x+w,y+h,x,y+h,r);
    ctx.arcTo(x,y+h,x,y,r);
    ctx.arcTo(x,y,x+w,y,r);
    if(fill) ctx.fill();
    ctx.strokeStyle = theme.line; ctx.lineWidth = 1; ctx.stroke();
  }

  function labelText(text, x, y, color){ ctx.fillStyle = color || theme.ink; ctx.fillText(text, x, y); }
  function blockTitle(text, x, y){ ctx.save(); ctx.shadowColor='rgba(255,255,255,0.8)'; ctx.shadowBlur=6; ctx.fillStyle=theme.ink; ctx.fillText(text, x, y); ctx.restore(); }

  async function ensureBase(){
    if(baseImg) return baseImg;
    try{ baseImg = await loadImage(BASE_IMAGE_URL); }
    catch(e){ console.warn('ベース画像読み込み失敗', e); baseImg = null; }
    return baseImg;
  }

  async function drawTicket(data){
    const W=canvas.width, H=canvas.height;

    // 背景（固定ベース or フォールバック）
    ctx.fillStyle = theme.bg; ctx.fillRect(0,0,W,H);
    const img = await ensureBase();
    if(img){ drawFittedImage(img, BASE_FIT); }
    else { // フォールバック：明るい帯＋白面
      ctx.fillStyle = '#ffffff'; roundRect(24,24, W-48, H-48, 24, true); lightBand(40,60, W-80, 90);
    }

    // 見出し
    ctx.fillStyle = theme.sub; ctx.font = '600 24px system-ui, "Noto Sans JP"'; labelText('予想順位', 72, 226, theme.sub);

    // 順位
    const labels=['1位','2位','3位'];
    const picks=[data.pick1,data.pick2,data.pick3].filter(Boolean);
    const baseY=300;
    picks.forEach((p,i)=>{
      const y = baseY + i*78;
      ctx.fillStyle = theme.accent; ctx.font = '800 40px system-ui'; labelText(labels[i], 84, y, theme.accent);
      ctx.fillStyle = theme.ink; ctx.font = '700 40px system-ui, "Noto Sans JP"'; labelText('： '+trunc(p,22), 160, y, theme.ink);
    });

    // フッター（ID・ニックネーム・発行時刻）
    const issuedAt = data.issuedAt ? new Date(data.issuedAt) : new Date();
    ctx.fillStyle = theme.subtle; roundRect(56, H-120, W-112, 64, 12, true);
    ctx.font = '600 20px system-ui'; ctx.fillStyle = theme.sub; labelText('回答ID', 72, H-84, theme.sub); labelText('ニックネーム', 360, H-84, theme.sub); labelText('発行時刻', 720, H-84, theme.sub);
    ctx.font = '700 26px system-ui'; ctx.fillStyle = theme.ink; labelText(data.answerId, 72, H-48, theme.ink); labelText(trunc(data.nickname||'—', 18), 360, H-48, theme.ink); labelText(formatTs(issuedAt), 720, H-48, theme.ink);

    // DLリンクとクリップボード
    const blob = await new Promise(res => canvas.toBlob(res, 'image/png', 0.95));
    const url = URL.createObjectURL(blob); $('#downloadLink').href = url; $('#downloadLink').download = `${data.answerId}.png`;
    $('#copyBtn').onclick = async ()=>{ try{ const item = new ClipboardItem({ 'image/png': blob }); await navigator.clipboard.write([item]); $('#status').textContent='画像をコピーしました。'; } catch(e){ $('#status').textContent='コピーに失敗しました（ブラウザ制限の可能性）。'; }};
  }

  function genAnswerId(){ return 'Q'+Date.now().toString(36).toUpperCase(); }

  const GAS_URL = "https://script.google.com/macros/s/AKfycbxo8KqSwhQ1czHIkDPr66b0MH1ar3KjF6xstS7g9qnEVL2XEW9s6poTSICIRklTHn6E/exec";

  async function onSubmit(){
    const data = {
      nickname: $('#nickname').value.trim(),
      pick1: $('#pick1').value.trim(),
      pick2: $('#pick2').value.trim(),
      pick3: $('#pick3').value.trim(),
      answerId: genAnswerId(),
      issuedAt: Date.now()
    };
    if(!data.pick1 || !data.pick2 || !data.pick3){
      $('#status').textContent = 'レース名と1〜3位は必須です。'; return;
    }
    // 画像発行
    await drawTicket(data);

    // ★ 回答をGASへ送信（集計用）
    try{
      await fetch(GAS_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          nickname: data.nickname,
          pick1: data.pick1,
          pick2: data.pick2,
          pick3: data.pick3,
          answerId: data.answerId
        })
      });
      $('#status').textContent = '発行＆提出を記録しました。';
    }catch(e){
      $('#status').textContent = '画像は発行しましたが、提出の記録に失敗しました。';
    }
  }

  // async function onSubmit(){
  //   const data={nickname: $('#nickname').value.trim(), pick1: $('#pick1').value.trim(), pick2: $('#pick2').value.trim(), pick3: $('#pick3').value.trim(), answerId: genAnswerId(), issuedAt: Date.now() };
  //   if(!data.pick1 || !data.pick2 || !data.pick3){ $('#status').textContent = '1〜3着の指定は必須です。'; return; }
  //   const img = await ensureBase();
  //   $('#status').textContent = img ? 'ベース画像で描画中…' : 'ベース画像が見つからないため、デフォルト背景で描画します。';
  //   await drawTicket(data);
  //   $('#status').textContent = '発行しました。PNG保存またはコピーできます。';
  // }

  $('#submitBtn').addEventListener('click', onSubmit);

  // 初期プレビュー
  (async()=>{
    await ensureBase();
    await drawTicket({ race:'デモ：順番あてグランプリ', nickname:'デモ', pick1:'Aチーム', pick2:'Bチーム', pick3:'Cチーム', answerId:'DEMO', issuedAt: Date.now() });
  })();
</script>
</body>
</html>