<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>順番あてクイズ｜馬券風チケット（明るいトーン＋外部ベース画像対応）</title>
  <style>
    :root {
      /* —— 明るいトーン —— */
      --bg:#f7fbff;          /* 背景（うすい水色系） */
      --card:#ffffff;        /* カード面 */
      --ink:#0f172a;         /* 文字色(濃い紺) */
      --muted:#64748b;       /* 補助テキスト */
      --line:#e2e8f0;        /* 枠線 */
      --acc:#16a34a;         /* アクセント(明るいグリーン) */
      --acc-ink:#062b12;     /* アクセント上の文字色 */
      --soft:#f1f5f9;        /* ソフト面(フッター帯など) */
      --focus:#60a5fa;       /* フォーカス青 */
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic UI","Meiryo",sans-serif}
    .wrap{max-width:980px;margin:0 auto;padding:24px}
    h1{margin:0 0 10px;font-size:24px}
    .lead{color:var(--muted);margin:0 0 12px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px}
    .row{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:780px){.row{grid-template-columns:1fr 1fr}}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,select{width:100%;background:#fff;color:var(--ink);border:1px solid var(--line);border-radius:10px;padding:10px}
    input:focus,select:focus{outline:3px solid color-mix(in oklab, var(--focus) 35%, transparent); border-color:var(--focus)}
    .btn{background:var(--acc);color:var(--acc-ink);border:none;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer}
    .btn.secondary{background:#e6f7ec;color:#064e3b;border:1px solid #b7ebc6}
    .btn.ghost{background:#ffffff; border:1px solid var(--line); color:#0f172a}
    .tips{font-size:12px;color:var(--muted)}
    canvas{max-width:100%;height:auto;border-radius:12px;border:1px solid var(--line);background:#fff}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>順番あてクイズ｜馬券風チケット（明るいトーン＋外部ベース画像対応）</h1>
    <p class="lead">スマホから予想を入力 → <b>外部のPNG/JPGをベース</b>にテキストを重ねて馬券風画像を発行します。<b>発行時刻</b>も印字。</p>

    <div class="card" style="margin-top:8px">
      <form id="quizForm" onsubmit="return false;" class="row">
        <div>
          <label>レース名</label>
          <input id="race" placeholder="例: 第◯回 クイズダービー" required />
        </div>
        <div>
          <label>ニックネーム（任意）</label>
          <input id="nickname" placeholder="例: そいち" />
        </div>
        <div>
          <label>1位 予想</label>
          <select id="pick1" required>
            <option value="">選択してください</option>
            <option>Aチーム</option><option>Bチーム</option><option>Cチーム</option><option>Dチーム</option>
          </select>
        </div>
        <div>
          <label>2位 予想</label>
          <select id="pick2" required>
            <option value="">選択してください</option>
            <option>Aチーム</option><option>Bチーム</option><option>Cチーム</option><option>Dチーム</option>
          </select>
        </div>
        <div>
          <label>3位 予想（任意）</label>
          <select id="pick3">
            <option value="">選択してください</option>
            <option>Aチーム</option><option>Bチーム</option><option>Cチーム</option><option>Dチーム</option>
          </select>
        </div>
        <div>
          <label>ベース画像URL（外部PNG/JPG）</label>
          <input id="baseImageUrl" placeholder="例: https://cdn.example.com/ticket_base.png" />
          <div class="tips">※ CORSが許可されたホスティング（Cloudinary / Netlify / GitHub Raw など）に置いてください。</div>
        </div>
        <div>
          <label>ベース画像のフィット</label>
          <select id="baseFit">
            <option value="cover">カバー（余白なし・天地左右をトリミング）</option>
            <option value="contain">コンテイン（全体表示・余白あり）</option>
          </select>
        </div>
        <div style="grid-column:1/-1; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <button class="btn" id="submitBtn">馬券風チケット発行</button>
          <a id="downloadLink" class="btn secondary" download>PNG保存</a>
          <button id="copyBtn" type="button" class="btn ghost">画像をコピー</button>
          <span id="status" class="tips"></span>
        </div>
      </form>
    </div>

    <div class="card" style="margin-top:12px">
      <h3 style="margin:0 0 8px">プレビュー</h3>
      <canvas id="ticket" width="1200" height="600" aria-label="馬券風プレビュー"></canvas>
      <p class="tips">推奨：横1200×縦600pxのベース画像。文字が重なる領域は安全マージン（上下48px, 左右56px）を空けると綺麗です。</p>
    </div>
  </div>

<script>
// ページ読込後に自動セット
document.getElementById('baseImageUrl').value = 'img/test.png';
</script>

<script>
  const $ = (s)=>document.querySelector(s);
  const canvas = $('#ticket');
  const ctx = canvas.getContext('2d');

  // —— 明るいパレット ——
  const theme = {
    bg:'#f7fbff', panel:'#ffffff', ink:'#0f172a', sub:'#475569',
    accent:'#16a34a', line:'#e2e8f0', subtle:'#f1f5f9', race:'#0ea5e9'
  };

  const pad = (n)=> String(n).padStart(2,'0');
  const formatTs = (d)=> `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  const trunc=(s,n)=>!s? s : (s.length>n? s.slice(0,n-1)+'…':s);

  function loadImage(url){
    return new Promise((resolve,reject)=>{
      if(!url) return resolve(null);
      const img = new Image();
      img.crossOrigin = 'anonymous'; // CORS必須
      img.onload = ()=> resolve(img);
      img.onerror = (e)=> reject(e);
      img.src = url + (url.includes('?')?'&':'?') + 't=' + Date.now(); // キャッシュバイパス
    });
  }

  function drawFittedImage(img, fit){
    const W = canvas.width, H = canvas.height;
    const ir = img.width / img.height; const cr = W / H;
    let dw, dh, dx, dy;
    if(fit==='contain'){
      const ratio = cr > ir ? H / img.height : W / img.width;
      dw = Math.round(img.width * ratio); dh = Math.round(img.height * ratio);
      dx = Math.round((W - dw) / 2); dy = Math.round((H - dh) / 2);
    }else{ // cover
      const ratio = cr > ir ? W / img.width : H / img.height;
      dw = Math.round(img.width * ratio); dh = Math.round(img.height * ratio);
      dx = Math.round((W - dw) / 2); dy = Math.round((H - dh) / 2);
    }
    ctx.drawImage(img, dx, dy, dw, dh);
  }

  function lightBand(x,y,w,h){
    const g = ctx.createLinearGradient(x,y,x+w,y);
    g.addColorStop(0,'#e0f2fe'); // 水色
    g.addColorStop(0.55,'#bae6fd');
    g.addColorStop(1,'#bbf7d0'); // みどり
    ctx.fillStyle=g; ctx.fillRect(x,y,w,h);
  }

  function roundRect(x,y,w,h,r,fill=true){
    ctx.beginPath();
    ctx.moveTo(x+r,y);
    ctx.arcTo(x+w,y,x+w,y+h,r);
    ctx.arcTo(x+w,y+h,x,y+h,r);
    ctx.arcTo(x,y+h,x,y,r);
    ctx.arcTo(x,y,x+w,y,r);
    if(fill) ctx.fill();
    ctx.strokeStyle = theme.line; ctx.lineWidth = 1; ctx.stroke();
  }

  function labelText(text, x, y, color){
    ctx.fillStyle = color || theme.ink; ctx.fillText(text, x, y);
  }

  function blockTitle(text, x, y){
    // 見出しはやや太く、影を薄く
    ctx.save();
    ctx.shadowColor = 'rgba(255,255,255,0.8)'; ctx.shadowBlur = 6;
    ctx.fillStyle = theme.ink; ctx.fillText(text, x, y);
    ctx.restore();
  }

  async function drawTicket(data){
    const W=canvas.width, H=canvas.height;

    // 背景（外部ベース or フォールバック）
    ctx.fillStyle = theme.bg; ctx.fillRect(0,0,W,H);
    if(data.baseImageUrl){
      try{ const img = await loadImage(data.baseImageUrl); if(img) drawFittedImage(img, data.baseFit||'cover'); }
      catch(e){ console.warn('ベース画像読み込み失敗', e); }
    }
    if(!data.baseImageUrl){ // フォールバック：明るい帯＋白面
      ctx.fillStyle = '#ffffff';
      roundRect(24,24, W-48, H-48, 24, true);
      lightBand(40,60, W-80, 90);
    }

    // タイトル / レース名
    ctx.font = 'bold 44px system-ui, "Noto Sans JP"';
    blockTitle('順番あてクイズ — 馬券風チケット', 56, 110);

    ctx.font = '700 40px system-ui, "Noto Sans JP"';
    ctx.fillStyle = theme.race; labelText(trunc(data.race,30), 56, 160);

    // 本文枠（白地）
    ctx.fillStyle = theme.panel; roundRect(56, 190, W-112, 300, 18, true);

    // 見出し
    ctx.fillStyle = theme.sub; ctx.font = '600 24px system-ui, "Noto Sans JP"';
    labelText('予想順位', 72, 226, theme.sub);

    // 順位
    const labels=['1位','2位','3位'];
    const picks=[data.pick1,data.pick2,data.pick3].filter(Boolean);
    const baseY=300;
    picks.forEach((p,i)=>{
      const y = baseY + i*78;
      ctx.fillStyle = theme.accent; ctx.font = '800 40px system-ui'; labelText(labels[i], 84, y, theme.accent);
      ctx.fillStyle = theme.ink; ctx.font = '700 40px system-ui, "Noto Sans JP"'; labelText('： '+trunc(p,22), 160, y, theme.ink);
    });

    // フッター（ID・ニックネーム・発行時刻）
    const issuedAt = data.issuedAt ? new Date(data.issuedAt) : new Date();
    ctx.fillStyle = theme.subtle; roundRect(56, H-120, W-112, 64, 12, true);

    ctx.font = '600 20px system-ui'; ctx.fillStyle = theme.sub;
    labelText('回答ID', 72, H-84, theme.sub);
    labelText('ニックネーム', 360, H-84, theme.sub);
    labelText('発行時刻', 720, H-84, theme.sub);

    ctx.font = '700 26px system-ui'; ctx.fillStyle = theme.ink;
    labelText(data.answerId, 72, H-48, theme.ink);
    labelText(trunc(data.nickname||'—', 18), 360, H-48, theme.ink);
    labelText(formatTs(issuedAt), 720, H-48, theme.ink);

    // DLリンクとクリップボード
    const blob = await new Promise(res => canvas.toBlob(res, 'image/png', 0.95));
    const url = URL.createObjectURL(blob);
    $('#downloadLink').href = url; $('#downloadLink').download = `${data.answerId}.png`;
    $('#copyBtn').onclick = async ()=>{
      try{ const item = new ClipboardItem({ 'image/png': blob }); await navigator.clipboard.write([item]); $('#status').textContent = '画像をコピーしました。'; }
      catch(e){ $('#status').textContent = 'コピーに失敗しました（ブラウザ制限の可能性）。'; }
    };
  }

  function genAnswerId(){ return 'Q'+Date.now().toString(36).toUpperCase(); }

  async function onSubmit(){
    const data={
      race: $('#race').value.trim(), nickname: $('#nickname').value.trim(),
      pick1: $('#pick1').value.trim(), pick2: $('#pick2').value.trim(), pick3: $('#pick3').value.trim(),
      baseImageUrl: $('#baseImageUrl').value.trim(), baseFit: $('#baseFit').value,
      answerId: genAnswerId(), issuedAt: Date.now()
    };
    if(!data.race || !data.pick1 || !data.pick2){ $('#status').textContent = 'レース名と1〜2位は必須です。'; return; }
    $('#status').textContent = data.baseImageUrl ? 'ベース画像を読み込み中…' : '明るいテーマで描画中…';
    await drawTicket(data);
    $('#status').textContent = '発行しました。PNG保存またはコピーできます。';
  }

  $('#submitBtn').addEventListener('click', onSubmit);

  // 初期プレビュー（明るいトーン）
  (async()=>{
    await drawTicket({
      race:'デモ：順番あてグランプリ', nickname:'デモ', pick1:'Aチーム', pick2:'Bチーム', pick3:'Cチーム',
      baseImageUrl:'', baseFit:'cover', answerId:'DEMO', issuedAt: Date.now()
    });
  })();
</script>
</body>
</html>
