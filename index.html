<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ã‚¦ã‚§ãƒ‡ã‚£ãƒ³ã‚°ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼  ğŸ‡ã‚µãƒ³ãƒ¬ãƒ³ã‚¿ãƒ³ğŸ‡ï½œé¦¬åˆ¸æŠ•ç¥¨ãƒšãƒ¼ã‚¸</title>
  <style>
    :root {
      /* æ˜ã‚‹ã„ãƒˆãƒ¼ãƒ³ */
      --bg:#f7fbff; --card:#ffffff; --ink:#0f172a; --muted:#64748b; --line:#e2e8f0; --acc:#16a34a; --acc-ink:#062b12; --soft:#f1f5f9; --focus:#60a5fa; --race:#0ea5e9;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic UI","Meiryo",sans-serif}
    .wrap{max-width:980px;margin:0 auto;padding:24px}
    h1{margin:0 0 10px;font-size:24px}
    .lead{color:var(--muted);margin:0 0 12px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px}
    .row{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:780px){.row{grid-template-columns:1fr 1fr}}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,select{width:100%;background:#fff;color:var(--ink);border:1px solid var(--line);border-radius:10px;padding:10px}
    input:focus,select:focus{outline:3px solid color-mix(in oklab, var(--focus) 35%, transparent); border-color:var(--focus)}
    .btn{background:var(--acc);color:var(--acc-ink);border:none;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer}
    .btn.secondary{background:#e6f7ec;color:#064e3b;border:1px solid #b7ebc6}
    .btn.ghost{background:#ffffff; border:1px solid var(--line); color:#0f172a}
    .tips{font-size:12px;color:var(--muted)}
    canvas{max-width:100%;height:auto;border-radius:12px;border:1px solid var(--line);background:#fff}
  </style>
  <!-- ä»»æ„ï¼šãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆåŒä¸€ã‚ªãƒªã‚¸ãƒ³ã®å›ºå®šãƒ™ãƒ¼ã‚¹ç”»åƒï¼‰ -->
  <link rel="preload" as="image" href="img/test.png">
</head>
<body>
  <div class="wrap">
    <h1>ã‚¦ã‚§ãƒ‡ã‚£ãƒ³ã‚°ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼  ğŸ‡ã‚µãƒ³ãƒ¬ãƒ³ã‚¿ãƒ³ğŸ‡ï½œé¦¬åˆ¸æŠ•ç¥¨ãƒšãƒ¼ã‚¸</h1>
    <p class="lead">ç¬¬1å• æ–°éƒã®å¥½ããªå¥³æ€§èŠ¸èƒ½äººã¯ï¼Ÿ</p>

    <div class="card" style="margin-top:8px">
      <form id="quizForm" onsubmit="return false;" class="row">
        <div>
          <label>ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </label>
          <input id="nickname" placeholder="ä¾‹: ã¯ã‚‰ã" />
        </div>
        <div>
          <label>1ä½ äºˆæƒ³</label>
          <select id="pick1" required>
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <option>1 æœ‰æ‘æ¶ç´”</option><option>2 å¤šéƒ¨æœªè¯å­</option><option>3 ã‚ã®</option><option>4 å¹¾ç”°ã‚Šã‚‰</option><option>5 ãƒ’ã‚³ãƒ­ãƒ’ãƒ¼</option><option>6 ãƒ©ãƒ©ãƒ³ãƒ‰ã‚µãƒ¼ãƒ¤</option><option>7 ã ã‚Œã‹</option>
          </select>
        </div>
        <div>
          <label>2ä½ äºˆæƒ³</label>
          <select id="pick2" required>
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <option>1 æœ‰æ‘æ¶ç´”</option><option>2 å¤šéƒ¨æœªè¯å­</option><option>3 ã‚ã®</option><option>4 å¹¾ç”°ã‚Šã‚‰</option><option>5 ãƒ’ã‚³ãƒ­ãƒ’ãƒ¼</option><option>6 ãƒ©ãƒ©ãƒ³ãƒ‰ã‚µãƒ¼ãƒ¤</option><option>7 ã ã‚Œã‹</option>
          </select>
        </div>
        <div>
          <label>3ä½ äºˆæƒ³</label>
          <select id="pick3">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <option>1 æœ‰æ‘æ¶ç´”</option><option>2 å¤šéƒ¨æœªè¯å­</option><option>3 ã‚ã®</option><option>4 å¹¾ç”°ã‚Šã‚‰</option><option>5 ãƒ’ã‚³ãƒ­ãƒ’ãƒ¼</option><option>6 ãƒ©ãƒ©ãƒ³ãƒ‰ã‚µãƒ¼ãƒ¤</option><option>7 ã ã‚Œã‹</option>
          </select>
        </div>
        <div style="grid-column:1/-1; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <button class="btn" id="submitBtn">é¦¬åˆ¸ç™ºè¡Œ</button>
          <a id="downloadLink" class="btn secondary" download>ç”»åƒä¿å­˜</a>
          <button id="copyBtn" type="button" class="btn ghost">ç”»åƒã‚’ã‚³ãƒ”ãƒ¼</button>
          <span id="status" class="tips"></span>
        </div>
      </form>
      <p class="tips" style="margin-top:8px">â€» ãƒ™ãƒ¼ã‚¹ç”»åƒã¯ <code>img/test.png</code> ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚<br>GitHub Pagesï¼ˆProject Pagesï¼‰ã®å ´åˆã€<code>index.html</code> ã¨åŒéšå±¤ã« <code>img/</code> ãƒ•ã‚©ãƒ«ãƒ€ã‚’ç½®ã„ã¦ãã ã•ã„ã€‚</p>
    </div>

    <div class="card" style="margin-top:12px">
      <h3 style="margin:0 0 8px">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
      <canvas id="ticket" width="850" height="530" aria-label="é¦¬åˆ¸é¢¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼"></canvas>
    </div>
  </div>

<script>
  const $ = (s)=>document.querySelector(s);
  const canvas = $('#ticket');
  const ctx = canvas.getContext('2d');

  // å›ºå®šãƒ™ãƒ¼ã‚¹ç”»åƒã®è¨­å®š
  const BASE_IMAGE_URL = 'img/test.png'; // ãƒªãƒã‚¸ãƒˆãƒªå†…ã®ç›¸å¯¾ãƒ‘ã‚¹
  const BASE_FIT = 'cover';              // 'cover' or 'contain'

  // æ˜ã‚‹ã„ãƒ‘ãƒ¬ãƒƒãƒˆ
  const theme = { bg:'#f7fbff', panel:'#ffffff', ink:'#0f172a', sub:'#475569', accent:'#16a34a', line:'#e2e8f0', subtle:'#f1f5f9', race:'#0ea5e9' };

  const pad = (n)=> String(n).padStart(2,'0');
  const formatTs = (d)=> `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  const trunc=(s,n)=>!s? s : (s.length>n? s.slice(0,n-1)+'â€¦':s);

  let baseImg = null; // ã‚­ãƒ£ãƒƒã‚·ãƒ¥

  function loadImage(url){
    return new Promise((resolve,reject)=>{
      const img = new Image();
      // åŒä¸€ã‚ªãƒªã‚¸ãƒ³æƒ³å®šï¼ˆGitHub Pages/Netlifyãªã©ï¼‰ã€‚CORSä¸è¦ã€‚
      img.onload = ()=> resolve(img);
      img.onerror = (e)=> reject(e);
      img.src = url + (url.includes('?')?'&':'?') + 't=' + Date.now(); // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¤ãƒ‘ã‚¹
    });
  }

  function drawFittedImage(img, fit){
    const W = canvas.width, H = canvas.height;
    const ir = img.width / img.height; const cr = W / H;
    let dw, dh, dx, dy;
    if(fit==='contain'){
      const ratio = cr > ir ? H / img.height : W / img.width;
      dw = Math.round(img.width * ratio); dh = Math.round(img.height * ratio);
      dx = Math.round((W - dw) / 2); dy = Math.round((H - dh) / 2);
    }else{ // cover
      const ratio = cr > ir ? W / img.width : H / img.height;
      dw = Math.round(img.width * ratio); dh = Math.round(img.height * ratio);
      dx = Math.round((W - dw) / 2); dy = Math.round((H - dh) / 2);
    }
    ctx.drawImage(img, dx, dy, dw, dh);
  }

  function lightBand(x,y,w,h){
    const g = ctx.createLinearGradient(x,y,x+w,y);
    g.addColorStop(0,'#e0f2fe'); g.addColorStop(0.55,'#bae6fd'); g.addColorStop(1,'#bbf7d0');
    ctx.fillStyle=g; ctx.fillRect(x,y,w,h);
  }

  function roundRect(x,y,w,h,r,fill=true){
    ctx.beginPath();
    ctx.moveTo(x+r,y);
    ctx.arcTo(x+w,y,x+w,y+h,r);
    ctx.arcTo(x+w,y+h,x,y+h,r);
    ctx.arcTo(x,y+h,x,y,r);
    ctx.arcTo(x,y,x+w,y,r);
    if(fill) ctx.fill();
    ctx.strokeStyle = theme.line; ctx.lineWidth = 1; ctx.stroke();
  }

  function labelText(text, x, y, color){ ctx.fillStyle = color || theme.ink; ctx.fillText(text, x, y); }
  function blockTitle(text, x, y){ ctx.save(); ctx.shadowColor='rgba(255,255,255,0.8)'; ctx.shadowBlur=6; ctx.fillStyle=theme.ink; ctx.fillText(text, x, y); ctx.restore(); }

  async function ensureBase(){
    if(baseImg) return baseImg;
    try{ baseImg = await loadImage(BASE_IMAGE_URL); }
    catch(e){ console.warn('ãƒ™ãƒ¼ã‚¹ç”»åƒèª­ã¿è¾¼ã¿å¤±æ•—', e); baseImg = null; }
    return baseImg;
  }

  async function drawTicket(data){
    const W=canvas.width, H=canvas.height;

    // èƒŒæ™¯ï¼ˆå›ºå®šãƒ™ãƒ¼ã‚¹ or ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
    ctx.fillStyle = theme.bg; ctx.fillRect(0,0,W,H);
    const img = await ensureBase();
    if(img){ drawFittedImage(img, BASE_FIT); }
    else { // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šæ˜ã‚‹ã„å¸¯ï¼‹ç™½é¢
      ctx.fillStyle = '#ffffff'; roundRect(24,24, W-48, H-48, 24, true); lightBand(40,60, W-80, 90);
    }

    // è¦‹å‡ºã—
    ctx.fillStyle = theme.sub; ctx.font = '600 24px system-ui, "Noto Sans JP"'; labelText('äºˆæƒ³é †ä½', 72, 226, theme.sub);

    // é †ä½
    const labels=['1ä½','2ä½','3ä½'];
    const picks=[data.pick1,data.pick2,data.pick3].filter(Boolean);
    const baseY=300;
    picks.forEach((p,i)=>{
      const y = baseY + i*78;
      ctx.fillStyle = theme.accent; ctx.font = '800 40px system-ui'; labelText(labels[i], 84, y, theme.accent);
      ctx.fillStyle = theme.ink; ctx.font = '700 40px system-ui, "Noto Sans JP"'; labelText('ï¼š '+trunc(p,22), 160, y, theme.ink);
    });

    // ãƒ•ãƒƒã‚¿ãƒ¼ï¼ˆIDãƒ»ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ãƒ»ç™ºè¡Œæ™‚åˆ»ï¼‰
    const issuedAt = data.issuedAt ? new Date(data.issuedAt) : new Date();
    ctx.fillStyle = theme.subtle; roundRect(56, H-120, W-112, 64, 12, true);
    ctx.font = '600 20px system-ui'; ctx.fillStyle = theme.sub; labelText('å›ç­”ID', 72, H-84, theme.sub); labelText('ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ', 360, H-84, theme.sub); labelText('ç™ºè¡Œæ™‚åˆ»', 720, H-84, theme.sub);
    ctx.font = '700 26px system-ui'; ctx.fillStyle = theme.ink; labelText(data.answerId, 72, H-48, theme.ink); labelText(trunc(data.nickname||'â€”', 18), 360, H-48, theme.ink); labelText(formatTs(issuedAt), 720, H-48, theme.ink);

    // DLãƒªãƒ³ã‚¯ã¨ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰
    const blob = await new Promise(res => canvas.toBlob(res, 'image/png', 0.95));
    const url = URL.createObjectURL(blob); $('#downloadLink').href = url; $('#downloadLink').download = `${data.answerId}.png`;
    $('#copyBtn').onclick = async ()=>{ try{ const item = new ClipboardItem({ 'image/png': blob }); await navigator.clipboard.write([item]); $('#status').textContent='ç”»åƒã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚'; } catch(e){ $('#status').textContent='ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆãƒ–ãƒ©ã‚¦ã‚¶åˆ¶é™ã®å¯èƒ½æ€§ï¼‰ã€‚'; }};
  }

  function genAnswerId(){ return 'Q'+Date.now().toString(36).toUpperCase(); }

  const GAS_URL = "https://script.google.com/macros/s/AKfycbxo8KqSwhQ1czHIkDPr66b0MH1ar3KjF6xstS7g9qnEVL2XEW9s6poTSICIRklTHn6E/exec";

  async function onSubmit(){
    const data = {
      nickname: $('#nickname').value.trim(),
      pick1: $('#pick1').value.trim(),
      pick2: $('#pick2').value.trim(),
      pick3: $('#pick3').value.trim(),
      answerId: genAnswerId(),
      issuedAt: Date.now()
    };
    if(!data.pick1 || !data.pick2 || !data.pick3){
      $('#status').textContent = 'ãƒ¬ãƒ¼ã‚¹åã¨1ã€œ3ä½ã¯å¿…é ˆã§ã™ã€‚'; return;
    }
    // ç”»åƒç™ºè¡Œ
    await drawTicket(data);

    // â˜… å›ç­”ã‚’GASã¸é€ä¿¡ï¼ˆé›†è¨ˆç”¨ï¼‰
    try{
      await fetch(GAS_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          nickname: data.nickname,
          pick1: data.pick1,
          pick2: data.pick2,
          pick3: data.pick3,
          answerId: data.answerId
        })
      });
      $('#status').textContent = 'ç™ºè¡Œï¼†æå‡ºã‚’è¨˜éŒ²ã—ã¾ã—ãŸã€‚';
    }catch(e){
      $('#status').textContent = 'ç”»åƒã¯ç™ºè¡Œã—ã¾ã—ãŸãŒã€æå‡ºã®è¨˜éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
    }
  }

  // async function onSubmit(){
  //   const data={nickname: $('#nickname').value.trim(), pick1: $('#pick1').value.trim(), pick2: $('#pick2').value.trim(), pick3: $('#pick3').value.trim(), answerId: genAnswerId(), issuedAt: Date.now() };
  //   if(!data.pick1 || !data.pick2 || !data.pick3){ $('#status').textContent = '1ã€œ3ç€ã®æŒ‡å®šã¯å¿…é ˆã§ã™ã€‚'; return; }
  //   const img = await ensureBase();
  //   $('#status').textContent = img ? 'ãƒ™ãƒ¼ã‚¹ç”»åƒã§æç”»ä¸­â€¦' : 'ãƒ™ãƒ¼ã‚¹ç”»åƒãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆèƒŒæ™¯ã§æç”»ã—ã¾ã™ã€‚';
  //   await drawTicket(data);
  //   $('#status').textContent = 'ç™ºè¡Œã—ã¾ã—ãŸã€‚PNGä¿å­˜ã¾ãŸã¯ã‚³ãƒ”ãƒ¼ã§ãã¾ã™ã€‚';
  // }

  $('#submitBtn').addEventListener('click', onSubmit);

  // åˆæœŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
  (async()=>{
    await ensureBase();
    await drawTicket({ race:'ãƒ‡ãƒ¢ï¼šé †ç•ªã‚ã¦ã‚°ãƒ©ãƒ³ãƒ—ãƒª', nickname:'ãƒ‡ãƒ¢', pick1:'Aãƒãƒ¼ãƒ ', pick2:'Bãƒãƒ¼ãƒ ', pick3:'Cãƒãƒ¼ãƒ ', answerId:'DEMO', issuedAt: Date.now() });
  })();
</script>
</body>
</html>